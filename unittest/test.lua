local iso8583 = require("iso8583")
local cjson = require("cjson")
local time = require("time")
local UT = require("UT")

local function bcdunzip(str)
    return ({str:gsub(".", function(c) return string.format("%02X", c:byte(1)) end)})[1]
end

local function bcdzip(str)
    return ({str:gsub("..", function(x) return string.char(tonumber(x, 16)) end)})[1]
end


function UT.test_unpack128_0200()
    local str8583 = "30323030F23C44C1B8E098100000000000000041313636323235383837383136373230303030303030303030303030303030303430383030313031373131323232393834303731313131323232393130313734393132343930303032313030303630383438363135383430303834383631353834303337363232353838373831363732303030303D34393132313230323436313732343831373234363130343939363232353838373831363732303030303D313536313536303530303035303030303030313031353831373234363231343030303034393132303D373831363732343738313D3030303030303030303D30343030303030303735353030303030303030303030303130313732333834303731313730353630303033383631343430333439303037303536D2F8D0D0BFA8CFFBB7D1BDBBD2D72020202020202020202020202020202020202020202020202020313536A33E90DC1A3C466D3236303030303030303030303030303030323330303030393630303037303030303030303030303030313032343030303030304930383034313035383430493030303030303537413837393341"
    local zip_str8583 = bcdzip(str8583)
    local tab8583 = iso8583.unpack128(zip_str8583)
--    iso8583.show8583(tab8583)
    UT.EXPECT_TRUE(tab8583[0] == "0200" and
                   tab8583[2] == "6225887816720000" and
                   tab8583[3] == "000000" and
                   tab8583[4] == "000000040800" and
                   tab8583[7] == "1017112229" and
                   tab8583[11] == "840711" and
                   tab8583[12] == "112229" and
                   tab8583[13] == "1017" and
                   tab8583[14] == "4912" and
                   tab8583[18] == "4900" and
                   tab8583[22] == "021" and
                   tab8583[25] == "00" and
                   tab8583[26] == "06" and
                   tab8583[32] == "48615840" and
                   tab8583[33] == "48615840" and
                   tab8583[35] == "6225887816720000=49121202461724817246" and
                   tab8583[36] == "996225887816720000=1561560500050000001015817246214000049120=7816724781=000000000=04000000755000000000000" and
                   tab8583[37] == "101723840711" and
                   tab8583[41] == "70560003" and
                   tab8583[42] == "861440349007056" and
                   tab8583[43] == "银行卡消费交易                          " and
                   tab8583[49] == "156" and
                   tab8583[52] == bcdzip("A33E90DC1A3C466D") and
                   tab8583[53] ==  "2600000000000000" and
                   tab8583[60] ==  "00009600070000000000001" and
                   tab8583[122]==  "000000I0804105840I000000" and
                   tab8583[128]==  "57A8793A")

end
--local str8583 = "30323130F23E40818AC0801000000000100000C13136363232353838373831363732303030303030303030303030303030303034303830303130313731313232323938343037313131313232323931303137393931323130313734393030303030383438363135383430303834383631353834303130313732333834303731313030373035363030303338363134343033343930303730353631353630333030303030393630303037303030303030303030303030313130303130303030383033303835383430303433353143533232303030303034353033303835383430202020303030303030303030303030303030303030303032343030303030304930383034313035383430493030303030303743343831343143"
--local str8583 = "30323030E238048188E180080000000000000001313936323232303832313039303030343330303030333330303030313031373133313931343032323934373133313931343130313730313230303038443030303030333130384430303030303331313031373234303232393437303030343030303138363134343033363031323030303459425320202020202020202020202020202020202020202020202020202020202020202020202020303035434B3032233135363037363031303030303030303030303030303633363434202020202020202020202020435550414D30303130303030313130303030303030303036CBEFCEF2BFD530313131383937383435343432323932343638354444"

function UT.test_unpack128_0210()
    local str8583 = "30323130E23A00818AC1800800000000100000013139363232323038323130393030303433303030303333303030303130313731333139313430323239343731333139313431303137313031373030303844303030303033313038443030303030333131303137323430323239343730303030303430303031383631343430333630313230303034303035434B3032233135363037363030303030303030303030303030303030303030303020202020203030302020435550414D30303130303030313130303030303030303036CBEFCEF2BFD53031313138393738343534343232303830313032303030303344453135323341"
    local zip_str8583 = bcdzip(str8583)

    local tab8583 = {}
    tab8583 = iso8583.unpack128(zip_str8583)
    --iso8583.show8583(tab8583)
    UT.EXPECT_TRUE(tab8583[0]   == "0210" and
                   tab8583[2]   == "6222082109000430000" and
                   tab8583[3]   == "330000" and 
                   tab8583[7]   == "1017131914" and
                   tab8583[11]  == "022947" and
                   tab8583[12]  == "131914" and
                   tab8583[13]  == "1017" and
                   tab8583[15]  == "1017" and
                   tab8583[25]  == "00" and
                   tab8583[32]  == "D0000031" and
                   tab8583[33]  == "D0000031" and
                   tab8583[37]  == "101724022947" and
                   tab8583[39]  == "00" and
                   tab8583[41]  == "00040001" and
                   tab8583[42]  == "861440360120004" and
                   tab8583[48]  == "CK02#" and
                   tab8583[49]  == "156" and
                   tab8583[61]  == "0000000000000000000000     000  CUPAM0010000110000000006孙悟空01118978454422" and
                   tab8583[100] == "01020000" and
                   tab8583[128] == "3DE1523A")


    --local str = ""
    --str = iso8583.pack128(tab8583)
    --UT.EXPECT_TRUE(zip_str8583 == str)
end

function UT.test_pack128()
    local tab8583 = {
        [0] = "0210",
        [2] = "6222082109000430000",
        [3] = "330000",
        [7] = "1017131914",
        [11]= "022947",
        [12]= "131914",
        [13]= "1017",
        [15]= "1017",
        [25]= "00",
        [32]= "D0000031",
        [33]= "D0000031",
        [37]= "101724022947",
        [39]= "00",
        [41]= "00040001",
        [42]= "861440360120004",
        [48]= "CK02#",
        [49]= "156",
        [61]= "0000000000000000000000     000  CUPAM0010000110000000006孙悟空01118978454422",
        [100]= "01020000",
        [128]= "3DE1523A",
    }
    local str = iso8583.pack128(tab8583)
    local str2 = "30323130E23A00818AC1800800000000100000013139363232323038323130393030303433303030303333303030303130313731333139313430323239343731333139313431303137313031373030303844303030303033313038443030303030333131303137323430323239343730303030303430303031383631343430333630313230303034303035434B3032233135363037363030303030303030303030303030303030303030303020202020203030302020435550414D30303130303030313130303030303030303036CBEFCEF2BFD53031313138393738343534343232303830313032303030303344453135323341"
    str2 = bcdzip(str2)
    UT.EXPECT_TRUE(str == str2)
end


--local str8583 = "0200302404C030C09811000000000000018420055710191202100006376225561272020000D1912D870E0FE47DFAA1000104996225561272020000D1561562927590004335013800000010101019121D000000000000D00000D01010004380D92ED52A355A0034333336413030313231303538343035353432343333363135368BA8F289A1BC8C5B26100000000000000014220061750006013844383342454437"

function UT.test_unpack64()
    local str8583 = "0200302404C030C098110000000000000184200557101912021D0006376225561272020000D1912D870E0FE47DFAA10F0104996225561272020000D1561562927590004335013800000010101019121D000000000000D00000D01010004380D92ED52A355A0034333336413030313231303538343035353432343333363135368BA8F289A1BC8C5B26100000000000000014220061750006013844383342454437"
    local zip_str8583 = bcdzip(str8583)
    local tab8583 = {}
    tab8583 = iso8583.unpack64(zip_str8583)
    --iso8583.show8583(tab8583)
    UT.EXPECT_TRUE(tab8583[0]  == "0200" and
                   tab8583[3]  == "000000" and
                   tab8583[4]  == "000000018420" and
                   tab8583[11] == "055710" and
                   tab8583[14] == "1912" and
                   tab8583[22] == "021" and
                   tab8583[25] == "00" and
                   tab8583[26] == "06" and 
                   tab8583[35] == "6225561272020000D1912D870E0FE47DFAA10" and 
                   tab8583[36] == "996225561272020000D1561562927590004335013800000010101019121D000000000000D00000D01010004380D92ED52A355A00" and 
                   tab8583[41] == "4336A001" and 
                   tab8583[42] == "210584055424336" and 
                   tab8583[49] == "156" and
                   tab8583[52] == bcdzip("8BA8F289A1BC8C5B") and
                   tab8583[53] == "2610000000000000" and
                   tab8583[60] == "22006175000601" and 
                   tab8583[64]== "8D83BED7")

    --local str = iso8583.pack64(tab8583)
    --str = bcdunzip(str)
    --UT.EXPECT_TRUE(str8583 == str)
end

function UT.test_pack64()
--[[
F0: [0200]
F1: [00110000 00100100 00000100 11000000 00110000 11000000 10011000 00010001]
F3: [000000]
F4: [000000018420]
F11: [055710]
F14: [1912]
F22: [021D]
F25: [00]
F26: [06]
F35: [6225561272020000D1912D870E0FE47DFAA10F]
F36: [996225561272020000D1561562927590004335013800000010101019121D000000000000D00000D01010004380D92ED52A355A00]
F41: [4336A001]
F42: [210584055424336]
F49: [156]
F52: [8BA8F289A1BC8C5B]
F53: [2610000000000000]
F60: [22006175000601]
F64: [8D83BED7] 
--]]
    local tab8583 = {
        [0] = "0200",
        [3] = "000000",
        [4] = "000000018420",
        [11] = "055710",
        [14] = "1912",
        [22] = "021",
        [25] = "00",
        [26] = "06",
        [35] = "6225561272020000D1912D870E0FE47DFAA10F",
        [36] = "996225561272020000D1561562927590004335013800000010101019121D000000000000D00000D01010004380D92ED52A355A00",
        [41] = "4336A001",
        [42] = "210584055424336",
        [49] = "156",
        [52] = bcdzip("8BA8F289A1BC8C5B"),
        [53] = "2610000000000000",
        [60] = "22006175000601",
        [64] = "8D83BED7",
    }
    local str = iso8583.pack64(tab8583)
    local str2 = "0200302404C030C098110000000000000184200557101912021D0006376225561272020000D1912D870E0FE47DFAA10F0104996225561272020000D1561562927590004335013800000010101019121D000000000000D00000D01010004380D92ED52A355A0034333336413030313231303538343035353432343333363135368BA8F289A1BC8C5B26100000000000000014220061750006013844383342454437"

    UT.EXPECT_TRUE(bcdunzip(str) == str2)
end

UT.run()
